(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{667:function(s,a,n){"use strict";n.r(a);var e=n(19),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"verdaccio-搭建私有-npm-仓库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#verdaccio-搭建私有-npm-仓库"}},[s._v("#")]),s._v(" verdaccio 搭建私有 npm 仓库")]),s._v(" "),n("h2",{attrs:{id:"工具准备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#工具准备"}},[s._v("#")]),s._v(" 工具准备")]),s._v(" "),n("p",[n("code",[s._v("verdaccio")]),s._v(" 虽然是一个私有仓库搭建工具，但本身也是一个基于 "),n("code",[s._v("npm")]),s._v(" 的包,所以服务器需要预先安装 "),n("code",[s._v("node")]),s._v(" 和 "),n("code",[s._v("npm")]),s._v(" ，安装完成后再安装 verdaccio：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 终端\nnpm install -g verdaccio --unsafe-perm # 安装\n# --unsafe-perm 参数是为了防止安装时grywarn权限报错\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("如果需要管理 node 进程的话使用 "),n("code",[s._v("pm2")]),s._v(" 是最好的选择，pm2 是一个进程管理工具,可以用它来管理你的 node 进程，并查看 node 进程的状态，当然也支持性能监控，进程守护，负载均衡等功能\npm2 文档地址：https://github.com/Unitech/pm2")]),s._v(" "),n("h2",{attrs:{id:"配置-verdaccio"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置-verdaccio"}},[s._v("#")]),s._v(" 配置 verdaccio")]),s._v(" "),n("p",[s._v("第一次运行 "),n("code",[s._v("verdaccio")]),s._v(" 时会创建一个默认配置文件,目录在 "),n("code",[s._v("~/.config/verdaccio/config.yaml")]),s._v(" ,此文件是 Verdaccio 的重要部分, 您可以在其中修改默认行为, 启用插件并扩展功能。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 直接输入verdaccio命令运行\nverdaccio\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("运行完成后打开默认配置文件")]),s._v(" "),n("h3",{attrs:{id:"默认配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#默认配置"}},[s._v("#")]),s._v(" 默认配置")]),s._v(" "),n("p",[s._v("具体配置项请查看 https://verdaccio.org/docs/zh-CN/configuration")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# config.yaml\nstorage: ./storage\n\nplugins: ./plugins\n\nweb:\n  title: Verdaccio\n\nauth:\n  htpasswd:\n    file: ./htpasswd\n\nuplinks:\n  npmjs:\n    url: https://registry.npmjs.org/\n\npackages:\n  '@*/*':\n    access: $all\n    publish: $authenticated\n    unpublish: $authenticated\n    proxy: npmjs\n\n  '**':\n    access: $all\n    publish: $authenticated\n    unpublish: $authenticated\n    proxy: npmjs\nserver:\n  keepAliveTimeout: 60\n\nmiddlewares:\n  audit:\n    enabled: true\nlogs:\n  - { type: stdout, format: pretty, level: http }\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br")])]),n("h3",{attrs:{id:"设置镜像源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#设置镜像源"}},[s._v("#")]),s._v(" 设置镜像源")]),s._v(" "),n("p",[s._v("verdaccio 可以设置多个镜像源，镜像源可以使得访问我们私有库镜像源时如果没有找到包，便会向镜像源去下载，我们加入 taobao 镜像源加快下载速度")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# config.yaml\nuplinks:\n taobao:\n    url: https://registry.npm.taobao.org/\n  npmjs:\n    url: https://registry.npmjs.org/\n\n    # 其他设置 ...\n# 其他设置 ...\npackages:\n  '@*/*':\n    proxy:\n      - taobao\n      - npmjs\n    # 其他设置 ...\n  '**':\n    proxy:\n      - taobao\n      - npmjs\n    # 其他设置 ...\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("h3",{attrs:{id:"权限管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#权限管理"}},[s._v("#")]),s._v(" 权限管理")]),s._v(" "),n("p",[s._v("默认情况下 "),n("code",[s._v("verdaccio")]),s._v(" 使用"),n("a",{attrs:{href:"https://github.com/verdaccio/verdaccio-htpasswd",target:"_blank",rel:"noopener noreferrer"}},[s._v("htpasswd 插件"),n("OutboundLink")],1),s._v(" 来管理权限，默认值为：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("packages:\n  '**':\n    access: $all\n    publish: $authenticated\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("packages: 控制包访问或发布控制，常用的包名正则有：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("**         # 匹配任意包\n@*/*       # 匹配任意 scope 包\n@npmuser/* # 匹配 scope 为 npmuser 的包\nnpmuser-*  # 匹配包名有 npmuser- 前缀的包\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("包详细配置属性请看下列表格")]),s._v(" "),n("p",[s._v("||~属性||类型||必须的||示例||支持||描述||\n||access||string||No||$all||all||定义允许访问包的用户组，值在下面表格||\n||publish||string||No||$authenticated||all||定义允许发布的用户,值在下面表格||\n||proxy||string||No||npmjs||all||针对特定的 uplink 限制查找||")]),s._v(" "),n("p",[s._v("用户组可选值有")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("$all")]),s._v(" （用户不限制）")]),s._v(" "),n("li",[n("code",[s._v("$anonymous")]),s._v(" （用户不限制）")]),s._v(" "),n("li",[n("code",[s._v("$authenticated")]),s._v(" （所有登录用户）")]),s._v(" "),n("li",[n("code",[s._v("username")]),s._v(" ( 用户名，需指定具体用户，可指定多个用户，用户间空格隔开，如 secret super-secret-area ultra-secret-area)")])]),s._v(" "),n("p",[s._v("例如：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('packages:\n\n  "**":\n    access: $authenticated\n    publish: kabob jack\n    unpublish: kabob jack\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("上面的配置则是只有 kabob 和 jack 能上传包和删除包，只有注册了的用户才能通过此仓库下载包\n设置完成后保存 使用 "),n("code",[s._v("verdaccio命令 # 启动 verdaccio")]),s._v(" 服务,然后会看到 log 信息")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("warn --- config file  - /Users/lc/.config/verdaccio/config.yaml\nwarn --- Plugin successfully loaded: htpasswd\nwarn --- Plugin successfully loaded: audit\nwarn --- http address - http://localhost:4873/ - verdaccio/3.11.5\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("说明已经启动成功，可以看到仓库的默认地址是 "),n("code",[s._v("http://localhost:4873/")]),s._v(" ,至此私有仓库就搭建完毕了")]),s._v(" "),n("h2",{attrs:{id:"发布流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#发布流程"}},[s._v("#")]),s._v(" 发布流程")]),s._v(" "),n("h3",{attrs:{id:"注册并登录用户"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注册并登录用户"}},[s._v("#")]),s._v(" 注册并登录用户")]),s._v(" "),n("p",[n("code",[s._v("npm adduser --registry http://localhost:4873")]),s._v(" 依次根据提示输入 username、password 以及 Email 即可")]),s._v(" "),n("h3",{attrs:{id:"上传私有包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#上传私有包"}},[s._v("#")]),s._v(" 上传私有包")]),s._v(" "),n("p",[s._v("进入到包根目录，执行发布命令即可\n"),n("code",[s._v("npm publish --registry http://localhost:4873")]),s._v(" ##开发使用")]),s._v(" "),n("h3",{attrs:{id:"nrm"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nrm"}},[s._v("#")]),s._v(" nrm")]),s._v(" "),n("p",[s._v("nrm 是一个 NPM 源管理器，允许你快速的在多个 NPM 源间切换 ，具体用法:https://www.npmjs.com/package/nrm ，安装完成后可以方便切换源和查看。\n"),n("code",[s._v("npm install -g nrm")]),s._v("\n我们先将 npm registry 设置为私有库的地址：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# npm config\nnpm config set registry http://xxx.com/\nnpm config get registry # -> http://xxx.com/\n\n# 或 nrm\nnrm add localnpm http://xxx.com/\nnrm use localnpm\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("如果是 ip 地址的话可以设置别名")]),s._v(" "),n("h3",{attrs:{id:"添加镜像源别名"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#添加镜像源别名"}},[s._v("#")]),s._v(" 添加镜像源别名")]),s._v(" "),n("p",[s._v("添加镜像别名后可以更直观的查看当前源\n"),n("code",[s._v("nrm add qwk http://192.168.1.136:4873")]),s._v(" "),n("code",[s._v("nrm ls")]),s._v(" 查看所有镜像源")]),s._v(" "),n("h3",{attrs:{id:"测试-npm-包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试-npm-包"}},[s._v("#")]),s._v(" 测试 npm 包")]),s._v(" "),n("p",[s._v("测试私有库镜像源对于普通的 npm 公共包的安装是否正常，建立一个空项目，安装 the-answer 这个包。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mkdir test-localnpm\ncd test-localnpm\nnpm init -y\nnpm i the-answer # 安装 the-answer\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("可以回到运行 verdaccio 的终端窗口可以看到一下内容，\n说明 verdaccio 从多个源获取包信息，并传回 npm 客户端。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("http --&amp;gt; 200, req: 'GET https://registry.npm.taobao.org/the-answer' (streaming)\nhttp --&amp;gt; 200, req: 'GET https://registry.npm.taobao.org/the-answer', bytes: 0/2632\nhttp --&amp;gt; 200, req: 'GET https://registry.npmjs.org/the-answer' (streaming)\nhttp --&amp;gt; 200, req: 'GET https://registry.npmjs.org/the-answer', bytes: 0/2661\nhttp &amp;lt;-- 200, user: null(127.0.0.1), req: 'GET /the-answer', bytes: 0/1122\nhttp &amp;lt;-- 200, user: null(127.0.0.1), req: 'GET /the-answer', bytes: 0/1122\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("而重新安装或全新安装的 log 则会变成：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("http &amp;lt;-- 304, user: null(127.0.0.1), req: 'GET /the-answer', bytes: 0/0\nhttp &amp;lt;-- 304, user: null(127.0.0.1), req: 'GET /the-answer', bytes: 0/0\nhttp --&amp;gt; 304, req: 'GET https://registry.npm.taobao.org/the-answer' (streaming)\nhttp --&amp;gt; 304, req: 'GET https://registry.npm.taobao.org/the-answer', bytes: 0/0\nhttp --&amp;gt; 304, req: 'GET https://registry.npmjs.org/the-answer' (streaming)\nhttp --&amp;gt; 304, req: 'GET https://registry.npmjs.org/the-answer', bytes: 0/0\nhttp &amp;lt;-- 200, user: null(127.0.0.1), req: 'GET /the-answer', bytes: 0/1122\nhttp &amp;lt;-- 200, user: null(127.0.0.1), req: 'GET /the-answer', bytes: 0/1122\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("一些地方的 http status 从 200 变成了 304，\n表示有缓存功能的存在，不会每次都重新从远端仓库下载包代码,\n尝试在代码中调用，可以发现 the-answer 这个包能够正常工作。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('// .js\nconst theAnswer = require("the-answer");\nconsole.log(theAnswer); // -&amp;gt; 42\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("end")])])}),[],!1,null,null,null);a.default=t.exports}}]);